### 系统环境
* 4台神州 KunTai A924 训练/推理服务器，每台8 * 910B3
* docker 部署
* MindIE 镜像版本 2.0.T3.1-800I-A2-py311-openeuler24.03-lts
* 权重为huggingface下载的deepseek-ai/DeepSeek-V3，用NPU_inference的fp8_cast_bf16.py脚本转换为bf16，转换过程未报错
* 权重文件存储在主服务器上，通过NFS共享给其它三台，路径一致

### MindIE推理部署，启动服务时报错
```
[llm] [ERROR] [acl_nn_operation.cpp:143] gmmNode call SetAclNNWorkspaceExecutor fail, error:161002
```

### 日志
日志文件较长，所以放在自己网站上
* 主服务器1 <https://ascend.ercmp.xyz/docs/log/mindieservice-gx1.log>
* 从服务器2 <https://ascend.ercmp.xyz/docs/log/mindieservice-gx2.log>
* 从服务器3 <https://ascend.ercmp.xyz/docs/log/mindieservice-gx3.log>
* 从服务器4 <https://ascend.ercmp.xyz/docs/log/mindieservice-gx4.log>

其中从服务器3报错比较特殊，`NPU out of memory`，只有这一台报这个错误，其它都是161002
```
[mindie-server] [ERROR] [model.py:40] : [Model]	>>> Exception:NPU out of memory. Tried to allocate 450.00 MiB (NPU 4; 60.97 GiB total capacity; 14.67 GiB already allocated; 14.67 GiB current active; 22.66 MiB free; 14.71 GiB reserved in total by PyTorch) If reserved memory is >> allocated memory try setting max_split_size_mb to avoid fragmentation.
```

### 相关版本

* cann(/usr/local/Ascend/ascend-toolkit/latest/version.cfg)显示是7.6.T13，**但实际/usr/local/Ascend/ascend-toolkit/latest/下的文件和目录都是软链接至8.2.RC2**
* 驱动版本24.1.rc2.2

版本详情我整理在了这里 https://ascend.ercmp.xyz/docs/ver.html

### 启动脚本
```
#!/bin/bash
# vim:ft=bash

set -e

#hostname=$(< /etc/hostname)
declare -A addr
addr[gx1]=172.20.84.67
addr[gx2]=172.20.84.77
addr[gx3]=172.20.84.189
addr[gx4]=172.20.84.50

echo hostname is: $HOSTNAME
echo IP is: ${addr[$HOSTNAME]}

#. set_env.sh

export ASCEND_HOME=/usr/local/Ascend

source $ASCEND_HOME/ascend-toolkit/set_env.sh
source $ASCEND_HOME/nnal/atb/set_env.sh
source $ASCEND_HOME/atb-models/set_env.sh
source $ASCEND_HOME/mindie/set_env.sh

export MIES_INSTALL_PATH=$ASCEND_HOME/mindie/latest/mindie-service
export LD_LIBRARY_PATH=${MIES_INSTALL_PATH}/lib:${MIES_INSTALL_PATH}/lib/grpc:${LD_LIBRARY_PATH}
export PYTHONPATH=${MIES_INSTALL_PATH}/bin:${PYTHONPATH}
export ATB_OPERATION_EXECUTE_ASYNC=1
export TASK_QUEUE_ENABLE=1
export HCCL_BUFFSIZE=120
# mindie-service日志
export MINDIE_LOG_TO_STDOUT=1
export MINDIE_LOG_TO_FILE=1
export MINDIE_LOG_LEVEL="error"
# 运行时日志
export ASCEND_SLOG_PRINT_TO_STDOUT=0
export ASCEND_GLOBAL_LOG_LEVEL=3
export ASCEND_GLOBAL_EVENT_ENABLE=1
# 加速库日志
export ATB_LOG_TO_FILE=1
export ATB_LOG_TO_FILE_FLUSH=0
export ATB_LOG_TO_STDOUT=1
export ATB_LOG_LEVEL=ERROR
# 模型库日志
export ASDOPS_LOG_TO_FILE=1
export ASDOPS_LOG_TO_STDOUT=1
export ASDOPS_LOG_LEVEL=ERROR
# OCK后处理日志
export OCK_LOG_LEVEL=ERROR
export OCK_LOG_TO_STDOUT=1

export MIES_CONTAINER_IP=${addr[$HOSTNAME]}

# MindIE 2.1
export RANK_TABLE_FILE=/data/rank_table.json
# MindIE 2.0
export RANKTABLEFILE=/data/rank_table.json
export HCCL_DETERMINISTIC=true

export ATB_LLM_HCCL_ENABLE=1
export ATB_LLM_COMM_BACKEND="hccl"
export HCCL_CONNECT_TIMEOUT=7200 # 该环境变量需要配置为整数，取值范围[120,7200]，单位s
# 双机：
#export WORLD_SIZE=16
# 四机：
export WORLD_SIZE=32
export HCCL_EXEC_TIMEOUT=0

# 解决权重加载过慢问题
export OMP_NUM_THREADS=1
# 设置显存比
export NPU_MEMORY_FRACTION=0.95

cd $MIES_INSTALL_PATH

echo Copy and edit config.json...
cp /data/config.json conf/
sed -i "/ipAddress/s/172.20.84.67/${addr[$HOSTNAME]}/" conf/config.json

echo Starting mindieservice_daemon...
mkdir -p /data/log
bin/mindieservice_daemon 2>&1 | tee /data/log/mindieservice-$HOSTNAME.log
```
